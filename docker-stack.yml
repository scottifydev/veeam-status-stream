
version: '3.8'

services:
  veeam-status:
    image: node:20-alpine
    command: >
      sh -c "
        apk add --no-cache wget unzip &&
        wget -O /tmp/repo.zip https://github.com/scottifydev/veeam-status-stream/archive/refs/heads/main.zip &&
        mkdir -p /app &&
        unzip /tmp/repo.zip -d /tmp &&
        mv /tmp/veeam-status-stream-main/* /app/ &&
        cd /app &&
        npm install &&
        npm run build &&
        npm install -g serve &&
        serve -s dist -l 8080
      "
    environment:
      - NODE_ENV=production
      - DOMAIN_NAME=${DOMAIN_NAME:-veeam-status.example.com}
    networks:
      - veeam-net
      - traefik-public
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.veeam-status.rule=Host(`${DOMAIN_NAME:-veeam-status.example.com}`)"
        - "traefik.http.services.veeam-status.loadbalancer.server.port=8080"
        - "traefik.http.routers.veeam-status.entrypoints=websecure"
        - "traefik.http.routers.veeam-status.tls=true"

networks:
  veeam-net:
    driver: overlay
  traefik-public:
    external: true

